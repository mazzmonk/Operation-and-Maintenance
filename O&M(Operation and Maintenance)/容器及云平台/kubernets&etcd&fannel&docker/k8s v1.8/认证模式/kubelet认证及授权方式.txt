Kubelet认证/授权

Kubelet认证
Kubelet授权

Kubelet的HTTPS端点暴露了可访问不同灵敏度数据的API,并允许您在节点上和容器内执行不同级别的功率操作.

本文档介绍了如何认证和授权访问kubelet的HTTPS端点.

Kubelet认证
默认情况下,对未被其他配置的身份验证方法拒绝的kubelet的HTTPS端点的请求将被视为匿名请求,并给予用户名system:anonymous 和一组system:unauthenticated.

禁用匿名访问401 Unauthorized并向未经身份验证的请求发送响应：
用--anonymous-auth=false开始kubelet

1.要为Kubelet的HTTPS端点启用X509客户端证书认证,请执行以下操作：
1.1 用--client-ca-file标志启动kubelet,提供一个CA bundle来验证客户端证书
1.2 设置API服务器--kubelet-client-certificate和--kubelet-client-key标志


2.要启用API承载令牌（包括服务帐户令牌）以用于向kubelet的HTTPS端点进行身份验证,请执行以下操作：

2.1 确保authentication.k8s.io/v1beta1在API服务器中启用API组
2.2 启动kubelet --authentication-token-webhook,--kubeconfig和--require-kubeconfig标志
Kubelet TokenReview在配置的API服务器上调用API以确定来自承载令牌的用户信息
注意：该标志--require-kubeconfig在Kubernetes 1.8版本中已被弃用,在将来的版本中将被删除.您不再需要--require-kubeconfig在Kubernetes 1.8中使用.

Kubelet授权
然后授权任何成功验证的请求（包括匿名请求）.默认的授权模式是AlwaysAllow,它允许所有请求.

细分访问kubelet API有许多可能的原因：

匿名认证已启用,但匿名用户调用kubelet API的能力应受限制
不记名令牌认证已启用,但任意API用户（如服务帐户）调用kubelet API的能力应受限制
客户端证书身份验证已启用,但只有部分由配置的CA签名的客户端证书应被允许使用kubelet API
要细分对kubelet API的访问权限,请将授权委托给API服务器：

确保authorization.k8s.io/v1beta1在API服务器中启用API组
与启动kubelet --authorization-mode=Webhook,--kubeconfig和--require-kubeconfig标志
Kubelet SubjectAccessReview在配置的API服务器上调用API以确定每个请求是否被授权
注意：该标志--require-kubeconfig在Kubernetes 1.8版本中已被弃用,在将来的版本中将被删除.您不再需要--require-kubeconfig在Kubernetes 1.8中使用.

Kubelet使用与apiserver相同的请求属性方法来授权API请求.

动词由传入请求的HTTP动词确定：

HTTP动词	请求动词
POST	创建
GET,HEAD	得到
放	更新
补丁	补丁
删除	删除
资源和子资源是根据传入请求的路径确定的：

Kubelet API	资源	子资源
/统计/ *	节点	统计
/度/ *	节点	指标
/日志/ *	节点	日志
/规格/ *	节点	规范
所有其他人	节点	代理
名称空间和API组属性始终是一个空字符串,并且资源名称始终是kubelet的NodeAPI对象的名称.

在此模式下运行时,请确保 传递给apiserver 的--kubelet-client-certificate和--kubelet-client-key标志所标识的用户具有以下属性的权限：

verb = *,resource = nodes,subresource = proxy
verb = *,resource = nodes,subresource = stats
verb = *,resource = nodes,subresource = log
verb = *,resource = nodes,subresource = spec
verb = *,resource = nodes,subresource = metrics
