PowerShell通过SSH进行远程处理
来源:
https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/ssh-remoting-in-powershell-core?view=powershell-7

PowerShell远程处理通常使用WinRM进行连接协商和数据传输.SSH现在可用于Linux和Windows平台,并允许进行真正的多平台PowerShell远程处理.

WinRM为PowerShell远程会话提供了一个强大的托管模型.目前,基于SSH的远程处理不支持远程端点配置和"足够的管理"(JEA).

SSH远程处理使您可以在Windows和Linux计算机之间执行基本的PowerShell会话远程处理.SSH远程处理在目标计算机上创建一个PowerShell主机进程作为SSH子系统.最终,我们将实现类似于WinRM的通用托管模型,以支持端点配置和JEA.

New-PSSession,Enter-PSSession和Invoke-Command的cmdlet现在有一个新的参数组来支持这个新的远程连接.

要创建远程会话,请使用HostName参数指定目标计算机,并为用户名提供UserName.以交互方式运行cmdlet时,系统会提示您输入密码.您也可以使用带有KeyFilePath 参数的私钥文件使用SSH密钥认证.

必须在所有计算机上安装PowerShell 6或更高版本,以及SSH.同时安装SSH客户端(ssh.exe)和服务器(sshd.exe),以便可以与计算机进行远程访问.Windows 10版本1809和Windows Server 2019现在提供Windows OpenSSH


########################################################################################
* 在Windows上安装PowerShell

先决条件
Windows 7 SP1,Server 2008 R2和更高版本支持最新版本的PowerShell.

要通过WSMan启用PowerShell远程处理,需要满足以下先决条件:

在Windows 10之前的Windows版本上安装Universal C Runtime.可通过直接下载或Windows Update获得.完全修补的系统已经安装了此软件包.
在Windows 7和Windows Server 2008 R2上安装Windows Management Framework(WMF)4.0或更高版本.

安装MSI软件包
MSI文件如下所示PowerShell-<version>-win-<os-arch>.msi.例如:

PowerShell-7.0.0-win-x64.msi
PowerShell-7.0.0-win-x86.msi

下载完成后,双击安装程序并按照提示进行操作.

安装程序将在Windows"开始"菜单中创建一个快捷方式.

默认情况下,软件包安装到 $env:ProgramFiles\PowerShell\<version>
您可以通过"开始"菜单或 $env:ProgramFiles\PowerShell\<version>\pwsh.exe
 注意

PowerShell 7将安装到新目录,并与Windows PowerShell 5.1并行运行.对于PowerShell Core 6.x,PowerShell 7是就地升级,它删除了PowerShell Core6.x.

将PowerShell 7安装到 $env:ProgramFiles\PowerShell\7
该$env:ProgramFiles\PowerShell\7文件夹已添加到$env:PATH
该$env:ProgramFiles\PowerShell\6文件夹被删除
如果需要与PowerShell 7并行运行PowerShell 6,请使用ZIP安装方法重新安装PowerShell 6 .

从命令行进行管理员安装
可以从命令行安装MSI软件包,从而使管理员无需用户交互即可部署软件包.MSI软件包包含以下属性来控制安装选项:

ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL-此属性控制用于将Open PowerShell项添加 到Windows资源管理器中的上下文菜单的选项.
ENABLE_PSREMOTING-此属性控制在安装过程中启用PowerShell远程处理的选项.
REGISTER_MANIFEST-此属性控制用于注册Windows事件日志清单的选项.
以下示例显示如何在启用所有安装选项的情况下以静默方式安装PowerShell.


msiexec.exe /package PowerShell-7.0.0-win-x64.msi /quiet ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1 ENABLE_PSREMOTING=1 REGISTER_MANIFEST=1
########################################################################################
来源:
https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-windows?view=powershell-7#msi


必须将SSH服务器配置为创建SSH子系统,以在远程计算机上托管PowerShell进程.并且,您必须启用 基于密码或密钥的身份验证.

##########################################################################################
* 安装OpenSSH

操作在powershell 7.0上执行

从Windows Server 2019或Windows 10 1809上的``设置''UI安装OpenSSH
OpenSSH客户端和服务器是Windows 10 1809的可安装功能.

要安装OpenSSH,请启动"设置",然后转到"应用程序">"应用程序和功能">"管理可选功能".

扫描此列表以查看是否已安装OpenSSH客户端.如果不是,则在页面顶部选择"添加功能",然后:

要安装OpenSSH客户端,请找到" OpenSSH Client",然后单击"安装".
要安装OpenSSH服务器,请找到" OpenSSH服务器",然后单击"安装".
安装完成后,返回"应用程序">"应用程序和功能">"管理可选功能",您应该会看到列出的OpenSSH组件.


使用PowerShell安装OpenSSH
要使用PowerShell安装OpenSSH,请首先以管理员身份启动PowerShell.要确保OpenSSH功能可用于安装:

Get-WindowsCapability -Online | ? Name -like 'OpenSSH*'

# This should return the following output:

Name  : OpenSSH.Client~~~~0.0.1.0
State : NotPresent
Name  : OpenSSH.Server~~~~0.0.1.0
State : NotPresent


然后,安装服务器和/或客户端功能:

# Install the OpenSSH Client
Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0

# Install the OpenSSH Server
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

# Both of these should return the following output:

Path          :
Online        : True
RestartNeeded : False


* 卸载OpenSSH

要使用Windows设置卸载OpenSSH,请启动"设置",然后转到"应用程序">"应用程序和功能">"管理可选功能".在已安装功能的列表中,选择OpenSSH Client或OpenSSH Server组件,然后选择"卸载".

要使用PowerShell卸载OpenSSH,请使用以下命令之一:

# Uninstall the OpenSSH Client
Remove-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0

# Uninstall the OpenSSH Server
Remove-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

如果该服务在卸载时正在使用中,则在删除OpenSSH之后可能需要重新启动Windows.


* SSH服务器的初始配置
要将OpenSSH服务器配置为最初在Windows上使用,请以管理员身份启动PowerShell,然后运行以下命令以启动SSHD服务:

Start-Service sshd
# OPTIONAL but recommended:
Set-Service -Name sshd -StartupType 'Automatic'
# Confirm the Firewall rule is configured. It should be created automatically by setup. 
Get-NetFirewallRule -Name *ssh*
# There should be a firewall rule named "OpenSSH-Server-In-TCP", which should be enabled
# If the firewall does not exist, create one
# 防火墙设置,未必需要
New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22

* SSH的初次使用
在Windows上安装OpenSSH服务器后,可以从安装了SSH客户端的任何Windows设备上使用PowerShell快速测试它.在PowerShell中,键入以下命令:

Ssh username@servername

到任何服务器的第一次连接将产生类似于以下内容的消息:

The authenticity of host 'servername (10.00.00.001)' can't be established.
ECDSA key fingerprint is SHA256:(<a large string>).
Are you sure you want to continue connecting (yes/no)?

答案必须是"是"或"否".回答"是"会将该服务器添加到本地系统的已知ssh主机列表中.

此时将提示您输入密码.为安全起见,键入时将不会显示您的密码.

连接后,您将看到类似于以下内容的命令shell提示符:

domain\username@SERVERNAME C:\Users\username>

Windows OpenSSH服务器使用的默认shell程序是Windows命令shell程序.

########################################################################################
来源:
https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse


* 在Windows计算机上设置
安装最新版本的PowerShell

您可以通过列出New-PSSession参数集来确认PowerShell具有SSH远程支持.您会注意到有以SSH开头的参数集名称.这些参数集包括SSH参数.

下述的命令必须在powershell 7.0(上述安装的)上执行

(Get-Command New-PSSession).ParameterSets.Name

Name
----
SSHHost
SSHHostHashParam

编辑sshd_config位于的文件$env:ProgramData\ssh.

确保启用了密码认证：

PasswordAuthentication yes

创建在远程计算机上托管PowerShell进程的SSH子系统：

Subsystem powershell c:/progra~1/powershell/6/pwsh.exe -sshs -NoLogo -NoProfile

即添加上述两行在c:ProgramData\ssh\sshd_config中,大概如下：

PasswordAuthentication yes

# override default of no subsystems
Subsystem	sftp	sftp-server.exe
Subsystem 	powershell	c:/progra~1/powershell/7/pwsh.exe -sshs -NoLogo -NoProfile

注意:
对于包含空格的任何文件路径,必须使用8.3短名称.Windows的OpenSSH中存在一个错误,该错误阻止空间在子系统可执行路径中工作.

Program Files在Windows中,该文件夹的8.3短名称通常为Progra~1.但是,您可以使用以下命令来确保：

Get-CimInstance Win32_Directory -Filter 'Name="C:\\Program Files"' |
  Select-Object EightDotThreeFileName

EightDotThreeFileName
---------------------
c:\progra~1

(可选)启用密钥身份验证：

PubkeyAuthentication yes

重新启动sshd服务.

Restart-Service sshd

将安装OpenSSH的路径添加到Path环境变量中.例如, C:\Program Files\OpenSSH\.此项允许ssh.exe找到.

* 测试
测试通过在一台linux机器上使用ssh命令windows机器上的powshell命令
例如:
ssh administrator@172.20.20.6 'nuget.exe  restore c:\jenkinsagent\workspace\master_yuyuan_merge_test\src\RedOutpost.sln -source http://172.20.20.3:8081/rep
ository/all-nuget/'

#ssh连接用的是windows服务器的用户名和密码,命令则是cmd下可以执行的命令(这里比较奇怪,按说应该是上述绑定的powershell)








